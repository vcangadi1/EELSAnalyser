
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>readEELSdata</title><meta name="generator" content="MATLAB 8.6"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2016-02-19"><meta name="DC.source" content="readEELSdata.m"><style type="text/css">
html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,font,img,ins,kbd,q,s,samp,small,strike,strong,sub,sup,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}:focus{outine:0}ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}

html { min-height:100%; margin-bottom:1px; }
html body { height:100%; margin:0px; font-family:Arial, Helvetica, sans-serif; font-size:10px; color:#000; line-height:140%; background:#fff none; overflow-y:scroll; }
html body td { vertical-align:top; text-align:left; }

h1 { padding:0px; margin:0px 0px 25px; font-family:Arial, Helvetica, sans-serif; font-size:1.5em; color:#d55000; line-height:100%; font-weight:normal; }
h2 { padding:0px; margin:0px 0px 8px; font-family:Arial, Helvetica, sans-serif; font-size:1.2em; color:#000; font-weight:bold; line-height:140%; border-bottom:1px solid #d6d4d4; display:block; }
h3 { padding:0px; margin:0px 0px 5px; font-family:Arial, Helvetica, sans-serif; font-size:1.1em; color:#000; font-weight:bold; line-height:140%; }

a { color:#005fce; text-decoration:none; }
a:hover { color:#005fce; text-decoration:underline; }
a:visited { color:#004aa0; text-decoration:none; }

p { padding:0px; margin:0px 0px 20px; }
img { padding:0px; margin:0px 0px 20px; border:none; }
p img, pre img, tt img, li img, h1 img, h2 img { margin-bottom:0px; } 

ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
ul li { padding:0px; margin:0px 0px 7px 0px; }
ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
ul li ol li { list-style:decimal; }
ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
ol li ol li { list-style-type:lower-alpha; }
ol li ul { padding-top:7px; }
ol li ul li { list-style:square; }

.content { font-size:1.2em; line-height:140%; padding: 20px; }

pre, code { font-size:12px; }
tt { font-size: 1.2em; }
pre { margin:0px 0px 20px; }
pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }
pre.error { color:red; }

@media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

span.keyword { color:#0000FF }
span.comment { color:#228B22 }
span.string { color:#A020F0 }
span.untermstring { color:#B20000 }
span.syscmd { color:#B28C00 }

.footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
.footer p { margin:0px; }
.footer a { color:#878787; }
.footer a:hover { color:#878787; text-decoration:underline; }
.footer a:visited { color:#878787; }

table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }





  </style></head><body><div class="content"><h2>Contents</h2><div><ul><li><a href="#4">Select .dm3 file from the folder.</a></li><li><a href="#6">Read spectrum data from .dm3 file</a></li><li><a href="#9">Create an EELS structure from si_struct</a></li><li><a href="#11">Display EELS</a></li><li><a href="#13">Manage output arguments</a></li></ul></div><pre class="codeinput"><span class="keyword">function</span> varargout = readEELSdata(fullpathname)
</pre><pre class="codeinput"><span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
<span class="comment">%   Input: (OPTIONAL)</span>
<span class="comment">%       fullpathname = 'C:\x\y\z.dm3'</span>
<span class="comment">%       fullpathname = No input or []</span>
<span class="comment">%</span>
<span class="comment">%   Output:(DEFAULT = EELS)</span>
<span class="comment">%       EELS = EELS data structure</span>
<span class="comment">%       si_struct = All data in structure format</span>
<span class="comment">%       (No output argument) = plotEELS(EELS)</span>
<span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
</pre><p>The routine construct a structure datatype <i>EELS</i> which contains all the required fields for EELS analysis. The data is read from a .dm3 file format of Gatan Digital Micrograph.</p><h2>Select .dm3 file from the folder.<a name="4"></a></h2><p>If no input argument then use <i>uigetfile</i> to open an file selector and select a <i>.dm3</i> file. A <i>.dm3</i> file could be a spectrum image or a single spectrum. If the file is not present then select <i>cancel</i> from the file selector window. This will send an error message in the command window. If the file is present, then path name of the selected file will be assigned to <i>EELS.Fullpathname</i>. A <i>fullpathname</i> can be passed as an input argument. The <i>fullpathname</i> is assigned to <i>EELS.Fullpathname</i>.</p><pre class="codeinput"><span class="keyword">if</span>(nargin&lt;1)
    [filename, pathname] = uigetfile({<span class="string">'.dm3'</span>},<span class="string">'File Selector'</span>);
    <span class="keyword">if</span> isequal(filename,0) || isequal(pathname,0)
       error(<span class="string">'User pressed cancel'</span>)
    <span class="keyword">else</span>
       EELS.Fullpathname = strcat(pathname,filename);
    <span class="keyword">end</span>
<span class="keyword">else</span>
    EELS.Fullpathname = fullpathname;
<span class="keyword">end</span>
</pre><h2>Read spectrum data from .dm3 file<a name="6"></a></h2><p>The <i>.dm3</i> file is read using <i>DM3Import.m</i> routine. The routine is written by <a href="http://www.mathworks.com/matlabcentral/fileexchange/29351-dm3-import-for-gatan-digital-micrograph">Robert McLeod</a>.</p><pre class="codeinput">si_struct=DM3Import(EELS.Fullpathname);
</pre><pre class="codeoutput">Opening /Users/veersaysit/Dropbox/Matlab/Ge-basedSolarCell_24082015/ADF_20kX_afterwards.dm3
Throwing away display
Parsing Image
</pre><p>All the data fields from dturcture <i>si_struct</i> are reassigned in the data structure <i>EELS</i>. The <i>si_struct</i> can be used independently. The orientation of the data correspends to <img src="readEELSdata_eq06231131383388592156.png" alt="$(X,Y)$" style="width:30px;height:11px;"> cartesian axis. The SI field in <i>EELS</i> structure will have image indexing <img src="readEELSdata_eq10126945882100017105.png" alt="$(row,column)$" style="width:67px;height:11px;">. Increase in <img src="readEELSdata_eq12362013959998143435.png" alt="$X$" style="width:10px;height:8px;">-coordinates correspends to increase in <img src="readEELSdata_eq00874602081651376608.png" alt="$column$" style="width:36px;height:8px;"> and increase in <img src="readEELSdata_eq07649107795707013777.png" alt="$Y$" style="width:9px;height:8px;">-coordinates corresponds to increase in <img src="readEELSdata_eq06703110382238345654.png" alt="$row$" style="width:19px;height:6px;">. Spectrum image will be treated as an image rather than points scattered in <img src="readEELSdata_eq06231131383388592156.png" alt="$(X,Y)$" style="width:30px;height:11px;">-coordinates.</p><h2>Create an EELS structure from si_struct<a name="9"></a></h2><div><ul><li>The presence of <i>image_data</i> and <i>zaxis</i> fields in <i>si_struct</i> corresponds to the presence of EELS spectrum image. It will be asigned to the field <i>EELS.SImage</i>. The data from <i>si_struct.image_data</i> are in the cartesian format. use <i>reshape</i> and <i>permute</i> functions of matlab to swap the <img src="readEELSdata_eq12362013959998143435.png" alt="$X$" style="width:10px;height:8px;"> and <img src="readEELSdata_eq07649107795707013777.png" alt="$Y$" style="width:9px;height:8px;">-coordinates which now corrsponds to <img src="readEELSdata_eq06703110382238345654.png" alt="$row$" style="width:19px;height:6px;"> and <img src="readEELSdata_eq00874602081651376608.png" alt="$column$" style="width:36px;height:8px;">.</li><li>The presence of <i>image_data</i>, <i>xaxis, _yaxis</i> and no <i>zaxis</i> in <i>si_struct</i> corresponds to the presence of overview image or survey image. It could be dark field (DF) or bright field (BF) image.</li><li>The presence of <i>image_data</i> and only <i>xaxis</i> field in <i>si_struct</i> corrsponds to the presence of single spectrum.</li><li>The presence of <i>spectra_data</i> field in <i>si_struct</i> correspends to single spectrum. This type of spectra are found in EELS atlas reference spectrum in Gatan Digital Micrograph.</li><li>The presence of only <i>xaxis</i> field in <i>si_struct</i> corresponds to a single spectrum.</li><li>For spectrum image the dispersion is mapped directly from <i>si_struct.zaxis.origin</i> to <i>EELS.dispersion</i> and for single spectrum the <i>si_struct.xaxis.origin</i> to <i>EELS.dispersion</i>.</li><li>If the probe step size <img src="readEELSdata_eq01348491417648944484.png" alt="$<0.1 \mu m$" style="width:41px;height:10px;"> use <img src="readEELSdata_eq10723276209929840213.png" alt="$nm$" style="width:16px;height:6px;"> scale.</li><li>Read convergence (<img src="readEELSdata_eq14221827199139923399.png" alt="$\alpha$" style="width:7px;height:6px;">) and collection angle (<img src="readEELSdata_eq17331442575217596290.png" alt="$\beta$" style="width:7px;height:10px;">). While saving the <i>.dm3</i> file in Gatan Digital Micrograph, if the <img src="readEELSdata_eq14221827199139923399.png" alt="$\alpha$" style="width:7px;height:6px;"> and <img src="readEELSdata_eq17331442575217596290.png" alt="$\beta$" style="width:7px;height:10px;"> are were not specified then the values will be dummy. User need to assign <img src="readEELSdata_eq14221827199139923399.png" alt="$\alpha$" style="width:7px;height:6px;"> and <img src="readEELSdata_eq17331442575217596290.png" alt="$\beta$" style="width:7px;height:10px;"> saperately in the code.</li><li>The number of channels are defined as same length as the spectrum. The energy-loss axis is calibrated from start of the spectra which is not channel number 1 (approx channel 100 for JEOL 2010F @sheffield) and the dispersion will be acounted by multiplying the channels by dispersion.</li><li>The dimensions of the spectrum image will be present in the field <i>SI_x</i> (no. of rows), <i>SI_y</i> (no. of columns) and <i>SI_z</i> (length of spectrum). The dimensions of survey image will be present in <i>Image_x</i> (no. of rows) and <i>Image_y</i> (no. of columns). If none of the fields described above are present the the routine shows an error message.</li></ul></div><pre class="codeinput"><span class="keyword">if</span>(isfield(si_struct,<span class="string">'image_data'</span>))
    <span class="comment">%EELS.data=si_struct.image_data;</span>
    <span class="keyword">if</span>(isfield(si_struct,<span class="string">'zaxis'</span>))
        <span class="comment">% Read SI_x, SI_y and SI_z size</span>
        [EELS.SI_y,EELS.SI_x,EELS.SI_z] = size(si_struct.image_data);
        EELS.SImage = permute(reshape(si_struct.image_data,<span class="keyword">...</span>
                                      EELS.SI_x,EELS.SI_y,EELS.SI_z),<span class="keyword">...</span>
                              [2,1,3]);
        [EELS.SI_x,EELS.SI_y,EELS.SI_z] = size(EELS.SImage);
        <span class="comment">% Read Dispersion information</span>
        EELS.dispersion=si_struct.zaxis.scale;
        <span class="comment">% Calibrate energy_loss_axis of the spectrum</span>
        channels = (1:1:EELS.SI_z);
        EELS.energy_loss_axis=((channels-si_struct.zaxis.origin)*EELS.dispersion)';
        <span class="comment">% Read step size and units</span>
        <span class="keyword">if</span>(si_struct.xaxis.scale &lt; 0.1)
            EELS.step_size.x = si_struct.xaxis.scale*1000;
            EELS.step_size.xunit = <span class="string">'nm'</span>;
        <span class="keyword">else</span>
            EELS.step_size.x = si_struct.xaxis.scale;
            EELS.step_size.xunit = si_struct.xaxis.units;
        <span class="keyword">end</span>
        <span class="keyword">if</span>(si_struct.yaxis.scale &lt; 0.1)
            EELS.step_size.y = si_struct.yaxis.scale*1000;
            EELS.step_size.yunit = <span class="string">'nm'</span>;
        <span class="keyword">else</span>
            EELS.step_size.y = si_struct.yaxis.scale;
            EELS.step_size.yunit = si_struct.yaxis.units;
        <span class="keyword">end</span>
        <span class="comment">% Define probe size</span>
        EELS.probe_size_nm = 0;
        <span class="comment">% Define Convergence and Collection angle</span>
        EELS.conv_angle_mrad = si_struct.conv_angle_mrad;
        EELS.coll_angle_mrad = si_struct.coll_angle_mrad;
        <span class="comment">% Read Magnification</span>
        EELS.mag = si_struct.mag;
    <span class="keyword">elseif</span>(isfield(si_struct,<span class="string">'xaxis'</span>) &amp;&amp; isfield(si_struct,<span class="string">'yaxis'</span>))
        <span class="comment">% Read Image</span>
        EELS.Image=si_struct.image_data;
        <span class="comment">% Read Image_x and Image_y size</span>
        [EELS.Image_x,EELS.Image_y] = size(EELS.Image);
        <span class="comment">% Read scale and units</span>
        <span class="keyword">if</span>(si_struct.xaxis.scale &lt; 0.1)
            EELS.scale.x = si_struct.xaxis.scale*1000;
            EELS.scale.xunit = <span class="string">'nm'</span>;
        <span class="keyword">else</span>
            EELS.scale.x = si_struct.xaxis.scale;
            EELS.scale.xunit = si_struct.xaxis.units;
        <span class="keyword">end</span>
        <span class="keyword">if</span>(si_struct.yaxis.scale &lt; 0.1)
            EELS.scale.y = si_struct.yaxis.scale*1000;
            EELS.scale.yunit = <span class="string">'nm'</span>;
        <span class="keyword">else</span>
            EELS.scale.y = si_struct.yaxis.scale;
            EELS.scale.yunit = si_struct.yaxis.units;
        <span class="keyword">end</span>
        <span class="comment">% Read Magnification</span>
        EELS.mag = si_struct.mag;
    <span class="keyword">elseif</span>(isfield(si_struct,<span class="string">'xaxis'</span>))
        <span class="comment">% Read spectrum</span>
        EELS.spectrum = si_struct.image_data';
        <span class="comment">% Read Dispersion information</span>
        EELS.dispersion=si_struct.xaxis.scale;
        <span class="comment">% Calibrate energy_loss_axis of the spectrum</span>
        channels=(1:1:length(EELS.spectrum));
        EELS.energy_loss_axis=((channels-si_struct.xaxis.origin)*EELS.dispersion)';
        <span class="comment">% Read Magnification</span>
        EELS.mag = si_struct.mag;
    <span class="keyword">end</span>
<span class="keyword">elseif</span>(isfield(si_struct,<span class="string">'spectra_data'</span>))
    <span class="comment">% Read spectrum</span>
    <span class="keyword">if</span>(iscolumn(si_struct.spectra_data{1,1}))
        EELS.spectrum=si_struct.spectra_data{1,1};
    <span class="keyword">else</span>
        EELS.spectrum=si_struct.spectra_data{1,1}';
    <span class="keyword">end</span>
    <span class="keyword">if</span>(isfield(si_struct,<span class="string">'xaxis'</span>))
        <span class="comment">% Read Dispersion information</span>
        EELS.dispersion=si_struct.xaxis.scale;
        <span class="comment">% Define number of channels</span>
        channels=(1:1:length(si_struct.spectra_data{1,1}));
        <span class="comment">% Calibrate energy_loss_axis of the spectrum</span>
        EELS.energy_loss_axis=((channels-si_struct.xaxis.origin)*EELS.dispersion)';
    <span class="keyword">end</span>
<span class="keyword">else</span>
    error(<span class="string">'Not a valid file'</span>);
<span class="keyword">end</span>
</pre><h2>Display EELS<a name="11"></a></h2><p>Display the <i>EELS</i> structure tree.</p><pre class="codeinput">strucdisp(EELS);
</pre><pre class="codeoutput">   |    
   |--- scale
   |       |    
   |       |-- xunit : 'nm'
   |       |-- yunit : 'nm'
   |       |------ x : 6.17981
   |       |------ y : 6.17981
   |       O
   |    
   |-- Fullpathname : '/Users/veersaysit/Dropbox/Matlab/Ge-basedSolarCell_24082015/ADF_20kX_afterwards.dm3'
   |------- Image_x : 512
   |------- Image_y : 512
   |----------- mag : 20000
   |--------- Image : [512x512 Array]
</pre><h2>Manage output arguments<a name="13"></a></h2><p>There can be up to two output argument. The primary output argument is <i>EELS</i> structure and secondary is <i>si_struct</i> from <i>DM3Import.m</i>. If no output arguments present then plot EELS.</p><pre class="codeinput"><span class="keyword">if</span>(nargout == 0)
    plotEELS(EELS);
<span class="keyword">else</span>
    varargout = {EELS,si_struct};
<span class="keyword">end</span>
</pre><img vspace="5" hspace="5" src="readEELSdata_01.png" style="width:319px;height:285px;" alt=""> <p class="footer"><br><a href="http://www.mathworks.com/products/matlab/">Published with MATLAB&reg; R2015b</a><br></p></div><!--
##### SOURCE BEGIN #####
function varargout = readEELSdata(fullpathname)
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%   Input: (OPTIONAL)
%       fullpathname = 'C:\x\y\z.dm3'
%       fullpathname = No input or []
%
%   Output:(DEFAULT = EELS)
%       EELS = EELS data structure
%       si_struct = All data in structure format
%       (No output argument) = plotEELS(EELS)
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%
% The routine construct a structure datatype _EELS_ which contains all the
% required fields for EELS analysis. The data is read from a .dm3 file
% format of Gatan Digital Micrograph. 

%% Select .dm3 file from the folder.
% If no input argument then use _uigetfile_ to open an file selector and 
% select a _.dm3_ file. A _.dm3_ file could be a spectrum image or a single
% spectrum. If the file is not present then select _cancel_ from the file 
% selector window. This will send an error message in the command window.
% If the file is present, then path name of the selected file will be 
% assigned to _EELS.Fullpathname_. A _fullpathname_ can be passed as an 
% input argument. The _fullpathname_ is assigned to _EELS.Fullpathname_.
%%
if(nargin<1)
    [filename, pathname] = uigetfile({'.dm3'},'File Selector');
    if isequal(filename,0) || isequal(pathname,0)
       error('User pressed cancel')
    else
       EELS.Fullpathname = strcat(pathname,filename);
    end
else
    EELS.Fullpathname = fullpathname;
end

%% Read spectrum data from .dm3 file
% The _.dm3_ file is read using _DM3Import.m_ routine. The routine is written
% by <http://www.mathworks.com/matlabcentral/fileexchange/29351-dm3-import-for-gatan-digital-micrograph Robert McLeod>.
%%
si_struct=DM3Import(EELS.Fullpathname);

%%
% All the data fields from dturcture _si_struct_ are reassigned in the data
% structure _EELS_. The _si_struct_ can be used independently. The
% orientation of the data correspends to $(X,Y)$ cartesian axis. The SI 
% field in _EELS_ structure will have image indexing $(row,column)$. 
% Increase in $X$-coordinates correspends to increase in $column$ and 
% increase in $Y$-coordinates corresponds to increase in $row$. Spectrum 
% image will be treated as an image rather than points scattered in 
% $(X,Y)$-coordinates.

%% Create an EELS structure from si_struct
% * The presence of _image_data_ and _zaxis_ fields in _si_struct_ 
% corresponds to the presence of EELS spectrum image. It will be asigned to
% the field _EELS.SImage_. The data from _si_struct.image_data_ are in the
% cartesian format. use _reshape_ and _permute_ functions of matlab to swap
% the $X$ and $Y$-coordinates which now corrsponds to $row$ and $column$.
% * The presence of _image_data_, _xaxis, _yaxis_ and no _zaxis_ in
% _si_struct_ corresponds to the presence of overview image or survey 
% image. It could be dark field (DF) or bright field (BF) image.
% * The presence of _image_data_ and only _xaxis_ field in _si_struct_
% corrsponds to the presence of single spectrum.
% * The presence of _spectra_data_ field in _si_struct_ correspends to
% single spectrum. This type of spectra are found in EELS atlas reference
% spectrum in Gatan Digital Micrograph.
% * The presence of only _xaxis_ field in _si_struct_ corresponds to a 
% single spectrum.
% * For spectrum image the dispersion is mapped directly from 
% _si_struct.zaxis.origin_ to _EELS.dispersion_ and for single spectrum the
% _si_struct.xaxis.origin_ to _EELS.dispersion_.
% * If the probe step size $<0.1 \mu m$ use $nm$ scale.
% * Read convergence ($\alpha$) and collection angle ($\beta$). While 
% saving the _.dm3_ file in Gatan Digital Micrograph, if the $\alpha$ and
% $\beta$ are were not specified then the values will be dummy. User need to
% assign $\alpha$ and $\beta$ saperately in the code.
% * The number of channels are defined as same length as the spectrum. The
% energy-loss axis is calibrated from start of the spectra which is not 
% channel number 1 (approx channel 100 for JEOL 2010F @sheffield) and the
% dispersion will be acounted by multiplying the channels by dispersion.
% * The dimensions of the spectrum image will be present in the field 
% _SI_x_ (no. of rows), _SI_y_ (no. of columns) and _SI_z_ (length of 
% spectrum). The dimensions of survey image will be present in _Image_x_ 
% (no. of rows) and _Image_y_ (no. of columns).
% If none of the fields described above are present the the routine shows an
% error message.
%%
if(isfield(si_struct,'image_data'))
    %EELS.data=si_struct.image_data;
    if(isfield(si_struct,'zaxis'))
        % Read SI_x, SI_y and SI_z size
        [EELS.SI_y,EELS.SI_x,EELS.SI_z] = size(si_struct.image_data);
        EELS.SImage = permute(reshape(si_struct.image_data,...
                                      EELS.SI_x,EELS.SI_y,EELS.SI_z),...
                              [2,1,3]);
        [EELS.SI_x,EELS.SI_y,EELS.SI_z] = size(EELS.SImage);
        % Read Dispersion information
        EELS.dispersion=si_struct.zaxis.scale;
        % Calibrate energy_loss_axis of the spectrum
        channels = (1:1:EELS.SI_z);
        EELS.energy_loss_axis=((channels-si_struct.zaxis.origin)*EELS.dispersion)';
        % Read step size and units
        if(si_struct.xaxis.scale < 0.1)
            EELS.step_size.x = si_struct.xaxis.scale*1000;
            EELS.step_size.xunit = 'nm';
        else
            EELS.step_size.x = si_struct.xaxis.scale;
            EELS.step_size.xunit = si_struct.xaxis.units;
        end
        if(si_struct.yaxis.scale < 0.1)
            EELS.step_size.y = si_struct.yaxis.scale*1000;
            EELS.step_size.yunit = 'nm';
        else
            EELS.step_size.y = si_struct.yaxis.scale;
            EELS.step_size.yunit = si_struct.yaxis.units;
        end
        % Define probe size
        EELS.probe_size_nm = 0;
        % Define Convergence and Collection angle
        EELS.conv_angle_mrad = si_struct.conv_angle_mrad;
        EELS.coll_angle_mrad = si_struct.coll_angle_mrad;
        % Read Magnification
        EELS.mag = si_struct.mag;
    elseif(isfield(si_struct,'xaxis') && isfield(si_struct,'yaxis'))
        % Read Image
        EELS.Image=si_struct.image_data;
        % Read Image_x and Image_y size
        [EELS.Image_x,EELS.Image_y] = size(EELS.Image);
        % Read scale and units
        if(si_struct.xaxis.scale < 0.1)
            EELS.scale.x = si_struct.xaxis.scale*1000;
            EELS.scale.xunit = 'nm';
        else
            EELS.scale.x = si_struct.xaxis.scale;
            EELS.scale.xunit = si_struct.xaxis.units;
        end
        if(si_struct.yaxis.scale < 0.1)
            EELS.scale.y = si_struct.yaxis.scale*1000;
            EELS.scale.yunit = 'nm';
        else
            EELS.scale.y = si_struct.yaxis.scale;
            EELS.scale.yunit = si_struct.yaxis.units;
        end
        % Read Magnification
        EELS.mag = si_struct.mag;
    elseif(isfield(si_struct,'xaxis'))
        % Read spectrum
        EELS.spectrum = si_struct.image_data';
        % Read Dispersion information
        EELS.dispersion=si_struct.xaxis.scale;
        % Calibrate energy_loss_axis of the spectrum
        channels=(1:1:length(EELS.spectrum));
        EELS.energy_loss_axis=((channels-si_struct.xaxis.origin)*EELS.dispersion)';
        % Read Magnification
        EELS.mag = si_struct.mag;
    end
elseif(isfield(si_struct,'spectra_data'))
    % Read spectrum
    if(iscolumn(si_struct.spectra_data{1,1}))
        EELS.spectrum=si_struct.spectra_data{1,1};
    else
        EELS.spectrum=si_struct.spectra_data{1,1}';
    end
    if(isfield(si_struct,'xaxis'))
        % Read Dispersion information
        EELS.dispersion=si_struct.xaxis.scale;
        % Define number of channels
        channels=(1:1:length(si_struct.spectra_data{1,1}));
        % Calibrate energy_loss_axis of the spectrum
        EELS.energy_loss_axis=((channels-si_struct.xaxis.origin)*EELS.dispersion)';
    end
else
    error('Not a valid file');
end

%% Display EELS
% Display the _EELS_ structure tree.

%%
strucdisp(EELS);

%% Manage output arguments
% There can be up to two output argument. The primary output argument is 
% _EELS_ structure and secondary is _si_struct_ from _DM3Import.m_. If no 
% output arguments present then plot EELS.
%%
if(nargout == 0)
    plotEELS(EELS);
else
    varargout = {EELS,si_struct};
end
##### SOURCE END #####
--></body></html>